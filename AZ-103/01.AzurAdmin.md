# Préparations pour les LABs Microsoft - Module 01
## Requis
À partir de l’adresse https://docs.microsoft.com/en-us/powershell/azure/install-Az-ps?view=azps-3.0.0
* Update to Windows PowerShell 5.1 if needed. If you're on Windows 10, you already have PowerShell 5.1 installed.
> $PSVersionTable.PSVersion

## PowerShell
> Install-Module -Name Az -AllowClobber -Scope CurrentUser
* Si nous avons multiples utilisateurs opérateurs sur Azure, quelle commande faut-il utiliser (AllUsers)
  > Install-Module -Name Az -AllowClobber -Scope AllUsers

## .Net
À partir de l’adresse https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed#net_d	
* Install .NET Framework 4.7.2 or later.
> (Get-ItemProperty "HKLM:SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full").Release -ge 461808

## Azur CLI
https://docs.microsoft.com/fr-ch/cli/azure/?view=azure-cli-latest
* lancer la commande AZ dans un cmd (run as admin)
* MSI installer: https://aka.ms/installazurecliwindows

## Putty
Pour connecter une machine Linux, ou Windows en mode CLI.
* https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html


# LABs
## Exercice 1: Cloud Shell
* cliquer sur l'icône "Cloud Shell" (>\_) en haut milieu droite
* choisir PowerShell
* créer un storage (Free trial account)
* Taper la commande
> Get-AzSubscription
* Affichage ?
> Fet-AzResourceGroup
* Affichage ?
* Basculer via le menu "drop-down" **PowerShell[v]** sur le **Bash**
> az account list

> az resource list

> code
* Utiliser {} et ...

## Exercice 2: Working with PowerShell Locally
### Az module pour Powershell
Pour autoriser l'exécution des scripts (Erreur: CouldNotAutoloadMatchingModule)
> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine
* Lancer un Power Shell en mode 'run as admin': Installation du module Az (AllUsers)
> Install-Module -Name Az -AllowClobber
* On peut y lancer des commande Azur CLI: Requis, Az installé, cf début de cette page.
> az login
* Mais ceci ne fonctionnera que dans un PowerShell, après avoir installé le module ([MSI](https://aka.ms/installazurecliwindows) package)
  * Cette commande peut être utilisée aussi bien dans un PowerShell quand dans un 'cmd', pourquoi ?
* idem que ?
> Login-AzAccount
* Non: Pourquoi ? La sessions doit être initiée depuis le module CLI comme pour l'univers PowerShell.
* Un timout de 20 minutes sur inactivité déconnectera la session.

### PowerShell
> Get-AzSubscription

> Get-AzResourceGroup
* New-AzResourceGroup -name <name> -location <location>
* Remove-AzResourceGroup -Name Test

## Exercice 3: Azure CLI locally
Requis, module MSI installé (cf ci-avant).
> az --version

> az login

> az group list
* pour avoir un affichage du JSON en mode plus lisible (surtout si multiples résultats)
> az group list --output table
* az group list --query "\[?name == '<rg name>']" pour filtrer
  
Création d'un groupe de ressource:
* az group create --name <name> --location <location>
> az group create --name testing01 --location francecentral

## Exercice 4: Resource Groups locks
> New-AzResourceLock -LockName Verrou1 -LockLevel CanNotDelete -ResourceGroupName testing01
* Observer la console: Sur le groupe de ressource, 'Verrous' (FR)
> Get-AzResourceLock

> Remove-AzResourceGroup -Name testing01
* Résultat ?
> Remove-AzResourceLock -LockName Verrou1 -ResourceGroupName testing01
* Raffraichir a liste des verrous sur la console
> Get-AzResourceLock

> Remove-AzResourceGroup -Name testing01

## Exercice 5: Templates
Ouvrir une page web: https://azure.microsoft.com/en-us/resources/templates/
* Sélectionner 'Deploy a simple Windows VM': https://azure.microsoft.com/en-us/resources/templates/101-vm-simple-windows/
* Browse on Github: https://github.com/Azure/azure-quickstart-templates/tree/master/101-vm-simple-windows/
* Visualize: http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-vm-simple-windows%2Fazuredeploy.json
* Clic pour basculer sur le "code", icône oeil pour revenir au visuel
  * visualisateur du fichier: 
  * https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-vm-simple-windows/azuredeploy.json
Depuis la console PowerShell (admin)
> Get-AzContext
* Si besoin: Connect-AzAccount, et _Set-AzContext -subscription < your subscription ID >_
> New-AzResourceGroup -Name testing02 -Location francecentral
* Le groupe ressource est prêt
> $templateUri = 'https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-vm-from-user-image/azuredeploy.json'

> New-AzResourceGroupDeployment -Name t02deployment1 -ResourceGroupName testing02 -TemplateUri $templateUri

Mais après il peut poser plein de questions pénibles, et donc plus simple de faire: **Deploy to Azure**
* https://azure.microsoft.com/en-us/resources/templates/101-vm-simple-windows/

Ensuite, regarder:
> Get-AzVM
* Avec le nom pour plus de détails
> Get-AzVM -Name SimpleWinVM -resourcegroupname TESTING02
* Avec une variable JSON pour collecter ces infos
> $vm02 = Get-AzVM -Name SimpleWinVM -resourcegroupname TESTING02

> $vm02

> $vm02.HardwareProfile.VmSize

> $vm02.OSProfile

Utilisation, exemple, pour modifier la taille de la machine
> $ResourceGroupName = "TESTING02"

> $vm02.HardwareProfile.VmSize = "Standard_DS2_v2"

> Update-AzVM -ResourceGroupName $ResourceGroupName -VM $vm
* Test optionnel, et cela peut ne pas fonctionner selon si la 'location' supporte ou pas l'option.

Supprimer la machine
> Remove-AzResourceGroup -Name TESTING02
* Cela peut prendre un moment...

***Suite:*** https://microsoftlearning.github.io/AZ-103-MicrosoftAzureAdministrator/

# Annexes
## Generic
* Options par régions: https://azure.microsoft.com/en-us/regions/offers/
* FAQ Free account: https://azure.microsoft.com/en-us/free/free-account-faq/
* IaaS? https://azure.microsoft.com/en-us/overview/what-is-iaas/
* Pricing calculator: https://azure.microsoft.com/fr-fr/pricing/calculator/
* Script Set-ArmVmAvailabilitySet: https://gallery.technet.microsoft.com/Set-Azure-Resource-Manager-f7509ec4
## Module 2
* Implementing Autoscale: https://docs.microsoft.com/en-us/azure/azure-monitor/platform/autoscale-best-practices
* Blob? https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction
* Extensions: https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/features-windows
